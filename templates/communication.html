<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ company }} ‚Äì {{ round_name }}</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
*{box-sizing:border-box;font-family:'Segoe UI',sans-serif}

body{
    margin:0;
    min-height:100vh;
    background:linear-gradient(135deg,#020617,#0f172a,#1e293b);
    color:white;
    padding:30px;
}

.header{text-align:center;margin-bottom:25px}
.header h2{font-size:28px}
.header span{color:#38bdf8;font-weight:600}

.progress{
    display:flex;
    justify-content:space-between;
    max-width:850px;
    margin:20px auto;
}
.step{
    flex:1;
    text-align:center;
    opacity:.4;
    font-size:13px;
}
.step.active{opacity:1;color:#22c55e;font-weight:600}

.box{
    display:none;
    max-width:850px;
    margin:auto;
    background:rgba(255,255,255,0.08);
    backdrop-filter:blur(14px);
    border-radius:20px;
    padding:30px;
    box-shadow:0 20px 40px rgba(0,0,0,.35);
}
.box.active{display:block}

button{
    margin-top:25px;
    padding:12px 26px;
    border:none;
    border-radius:12px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    background:linear-gradient(135deg,#22c55e,#4ade80);
    color:#052e16;
}
button:disabled{opacity:.6}

.timer{color:#38bdf8;margin-top:10px;font-weight:600}
.mic{color:#fbbf24;margin-top:8px}

.read-box{
    background:#020617;
    padding:18px;
    border-radius:12px;
    margin-top:15px;
    border-left:4px solid #38bdf8;
}

input[type=text]{
    width:100%;
    padding:14px;
    border-radius:10px;
    border:none;
    margin-top:12px;
}
</style>
</head>

<body>

<div class="header">
    <h2>{{ company }} <span>‚Äì {{ round_name }}</span></h2>
</div>

<div class="progress">
    <div class="step active" id="s1">üéß Listening</div>
    <div class="step" id="s2">‚úç Fill</div>
    <div class="step" id="s3">üìñ Reading</div>
    <div class="step" id="s4">üé§ Topic</div>
</div>

<form method="POST" id="commForm" enctype="multipart/form-data">

<!-- START -->
<div class="box active" id="startBox">
    <h3>Start Communication Round</h3>
    <p class="mic">üéô Microphone permission required</p>
    <button type="button" id="startBtn" onclick="startListening()">Start</button>
</div>

<!-- LISTENING -->
<div class="box" id="listeningBox">
    <h3>üéß Listening & Speaking</h3>
    <div class="mic"><i class="fa fa-microphone"></i> Speak clearly</div>
    <div class="timer" id="listenTimer"></div>
</div>

{% for q in listening_questions %}
<input type="file"
       name="listening_audio_{{ loop.index0 }}"
       id="listening_audio_{{ loop.index0 }}"
       accept="audio/*"
       hidden>
{% endfor %}

<!-- FILL -->
<div class="box" id="fillBox">
    <h3>‚úç Fill in the Blanks</h3>
    <div class="read-box" id="fillQ"></div>
    <input type="text" id="fillInput" autocomplete="off">
    <button type="button" onclick="saveFill()">Next</button>
</div>

{% for f,_ in fill_questions %}
<input type="hidden" name="fill_{{ loop.index0 }}" id="fill_{{ loop.index0 }}">
{% endfor %}

<!-- READING -->
<div class="box" id="readingBox">
    <h3>üìñ Reading Aloud</h3>
    <div class="read-box">{{ reading_paragraph }}</div>
    <div class="timer" id="readTimer"></div>
    <button type="button" onclick="goToTopic()">Next</button>
</div>

<input type="file" name="reading_audio" id="reading_audio" accept="audio/*" hidden>

<!-- TOPIC -->
<div class="box" id="topicBox">
    <h3>üé§ Topic Speaking</h3>
    <div class="read-box">{{ topic }}</div>
    <div class="timer" id="topicTimer"></div>
    <button type="button" onclick="submitForm()">Submit</button>
</div>

<input type="file" name="topic_audio" id="topic_audio" accept="audio/*" hidden>

</form>

<script>
/* ---------------- DATA ---------------- */
const listeningQ = {{ listening_questions|tojson }};
const fillQ = {{ fill_questions|tojson }};
let l = 0, f = 0;
let activeTimer = null;

/* ---------------- AUDIO RECORDER ---------------- */
let mediaRecorder;
let audioChunks = [];

async function startAudioRecording(inputId){
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];

  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

  mediaRecorder.onstop = () => {
    const blob = new Blob(audioChunks, { type:"audio/webm" });
    const file = new File([blob], "audio.webm", { type:"audio/webm" });
    const input = document.getElementById(inputId);
    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
  };

  mediaRecorder.start();
}

function stopAudioRecording(){
  if(mediaRecorder && mediaRecorder.state !== "inactive"){
    mediaRecorder.stop();
  }
}

/* ---------------- UTIL ---------------- */
function show(id){
 document.querySelectorAll(".box").forEach(b=>b.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

function step(n){
 document.querySelectorAll(".step").forEach(s=>s.classList.remove("active"));
 document.getElementById("s"+n).classList.add("active");
}

function clearTimer(){
 if(activeTimer){ clearInterval(activeTimer); activeTimer=null; }
}

function startCountdown(el, seconds, onEnd){
 clearTimer();
 let t = seconds;
 activeTimer = setInterval(()=>{
   el.innerText = `‚è± ${t--} sec`;
   if(t < 0){
     clearTimer();
     onEnd && onEnd();
   }
 },1000);
}

/* ---------------- START ---------------- */
async function startListening(){
 document.getElementById("startBtn").disabled = true;
 await navigator.mediaDevices.getUserMedia({ audio:true });
 step(1);
 show("listeningBox");
 playListening();
}

/* ---------------- LISTENING ---------------- */
function playListening(){
 if(l >= listeningQ.length){
   step(2);
   showFill();
   return;
 }

 speechSynthesis.speak(new SpeechSynthesisUtterance(listeningQ[l]));
 startAudioRecording("listening_audio_" + l);

 startCountdown(
   document.getElementById("listenTimer"),
   15,
   ()=>{
     stopAudioRecording();
     l++;
     playListening();
   }
 );
}

/* ---------------- FILL ---------------- */
function showFill(){
 show("fillBox");
 document.getElementById("fillQ").innerText = fillQ[f][0];
}

function saveFill(){
 document.getElementById("fill_"+f).value =
   document.getElementById("fillInput").value.trim();
 document.getElementById("fillInput").value="";
 f++;
 if(f >= fillQ.length){
   step(3);
   startReading();
 } else showFill();
}

/* ---------------- READING ---------------- */
function startReading(){
 show("readingBox");
 startAudioRecording("reading_audio");
 startCountdown(
   document.getElementById("readTimer"),
   60,
   ()=>stopAudioRecording()
 );
}

/* ---------------- TOPIC ---------------- */
function goToTopic(){
 step(4);
 show("topicBox");
 startAudioRecording("topic_audio");
 startCountdown(
   document.getElementById("topicTimer"),
   60,
   ()=>stopAudioRecording()
 );
}

/* ---------------- SUBMIT ---------------- */
function submitForm(){
 clearTimer();
 stopAudioRecording();
 document.getElementById("commForm").submit();
}
</script>

</body>
</html>
